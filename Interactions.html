<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="interactions.css">
		<title>Medications Interactions</title>
	</head>
	<body>
		<header>
			<nav class="navbar justify-content-between navbar-light" style="background-color: #eee">
				<a class="navbar-brand" href="#">
					<img src="interactions_logo.svg" width="30" height="30" class="d-inline-block align-top" alt="logo: 3 intersecting rings">
					Medication Interactions
				</a>
				<ul class="navbar-nav mr-auto"></ul>
				<form id="searchForm" class="form-inline my-2 my-lg-0">
					<input id="searchBox" class="form-control typeahead mr-md-2" placeholder="Type to search..." type="search" aria-label="Search" data-provide="typeahead" autocomplete="off">
      				<button id="submitButton" class="btn btn-outline-secondary disabled" type="submit">Add Medication</button>
    			</form>
			</nav>
		</header>
		
		<main role="main">
			<div class="container-fluid">
				<table id="resultsTable" class="table text-center"></table>
			</div>
		</main>
		
		<footer class="footer fixed-bottom" style="background-color: #fff;">
			<div class="container text-center">
				<span class="text-muted">
					Copyright &copy; Adrian Robinson 2019
					| <a href='http://transilluminate.org/' target='_new'>transilluminate.org</a>
					| Data from the <a href='https://bnf.nice.org.uk/' target='_new'>BNF</a> <i class="fas fa-heart text-danger"></i>
				</span>
			</div>
		</footer>
		
		<div class="container d-none" id="hiddenDiv"></div>

		<script src='https://kit.fontawesome.com/8fd8176edb.js'></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.2.1/bloodhound.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.2.1/typeahead.jquery.min.js"></script>
		
		<script>
		
		jQuery(document).ready( function(){	// once the page has loaded, let's start

			// define variables
			var availableMedications = [];	// array for all medications listed in the BNF ( availableMedications = [medication1...] )
			var displayMedications   = [];	// empty array of the meds we are going to add via the search box
			var medicationDetails    = {};	// this stores the details of the interactions of the medications

			function loadAvailableMedications(){	// build the medication list for the search terms, including urls to the JSON data
				$.ajax({ url:'https://bnf.nice.org.uk/interaction/index.html', type:'get', dataType:'html',
   					success:function(data){
   						
   						var html = $.parseHTML(data);
 						var medicationsList = $(html).find('#A,#B,#C,#D,#E,#F,#G,#H,#I,#J,#K,#L,#M,#N,#O,#P,#Q,#R,#S,#T,#U,#V,#W,#X,#Y,#Z').find('li');
 						medicationsList.each( function(){
							var title = $(this)[0].textContent.toLowerCase().trim();	// put this lowercase to make matching easier
							var json = $(this)[0].innerHTML.replace(/<a href=\"(.+).html.*/,"https://bnf.nice.org.uk/interaction/$1.json"); // grab the json url
							availableMedications.push(title);					// push this into the array of medications
							medicationDetails[title] = { 'json': json };		// and store the urls to the JSON separately
							// console.log("'" + title + "' => '" + json + "'");	// uncomment to display the loading of the availableMedications
 						});			
	 					// once searchArray has been loaded, initialise the typeahead
	 					var searchSuggestions = new Bloodhound({					// initialise a new search engine...
	 													datumTokenizer:Bloodhound.tokenizers.whitespace,	// voodoo
	 													queryTokenizer:Bloodhound.tokenizers.whitespace,	// magic
	 													local:availableMedications	// ... based on the array we just built
													});
						// attach the typeahead actions to the search box
						$("#searchBox").typeahead({ hint:false, highlight:true, minLength:1 },{ source:searchSuggestions, limit:8 });
						// once finished focus on the box
						$("#searchBox").focus();
   					}
				});	
			}

			// bind the 'submit' synonyms
			$('.typeahead').bind('typeahead:select', function(event,term) {
				if (term && availableMedications.includes(term) && !displayMedications.includes(term)) {
					addMedication(term);
				}
				$("#searchBox").focus();	// inconsistent, __TODO__
			});
			
			$("#submitButton").click( function(event) {
				event.preventDefault();	// stop the form from properly firing
				term = $("#searchBox").val().toLowerCase();
				
				if (term && availableMedications.includes(term) && !displayMedications.includes(term)) {
					addMedication(term);
				}
				$("#searchBox").focus();	// grrr, __TODO__				
			});

			function addMedication(term) {				
				if (term && availableMedications.includes(term) && !displayMedications.includes(term) && medicationDetails[term]['json']) {	// sanity checks
					$.getJSON(medicationDetails[term]['json'], function(jsonObject){		// async call				
						// the JSON tree is fairly complex, use an online explorer to understand (i.e. https://jsonformatter.org/json-viewer)
						var title = jsonObject['@graph'][0]['hasTitle']['@value'].replace(/(<([^>]+)>)/ig,"").trim().toLowerCase().toString();	// strip html
						var link = jsonObject['@graph'][0]['@id'].toString() + ".html";		// append '.html' to the link
						displayMedications.push(title);										// push into simple 1 dimensional array for quick iteration later
						medicationDetails[title]['url'] = link;								// the 'url' is a link to further details on the drug
						medicationDetails[title]['interactions'] = {};						// the 'interactions' is currently empty, we look at each one below
						$.each(jsonObject['@graph'][0]['hasInteraction'], function( index, object ) {	// get the array object 'hasInteraction', iterate over it
							var interactionTitle	= object['hasTitle']['@value'].replace(/(<([^>]+)>)/g,"").toLowerCase().toString();	// again, strip the HTML tags
							var interactionLink		= object['@id'].replace(/#/,".html#").toString();						// add .html within the sctring, before '#'
							var interactionSeverity	= object['hasMessage'][0]['hasImportance'].toString();					// grab the severity of interaction
							// the info string needs a bit of tidying, multiple spaces, hanging periods...
							var interactionDetails	= object['hasMessage'][0]['hasTextContent'].replace(/\r?\n|\r/g,"").replace(/ {1,}/g," ").replace(/ \./g,".").toString();
							// then push this into a fairly complex data structure, that can be expanded later with more details:
							medicationDetails[title]['interactions'][interactionTitle] = { 'url': interactionLink, 'severity': interactionSeverity, 'details': interactionDetails };
							// for example:	medicationDetails['simvastatin']['interactions']['Clarithromycin'][severity] = 'Severe'
							//				medicationDetails['simvastatin']['url'] = 'https://bnf.nice.org.uk/...'
						});
						redrawTable();	// now we have data, redraw the table
					});
				}
			};
			
			function deleteMedication(entry) {
				if (entry && displayMedications.includes(entry)) {							// sanity check
					displayMedications.splice( $.inArray(entry, displayMedications), 1 );	// splice out the entry
				}				
				redrawTable();	// refresh the table
			}
			
			function redrawTable() {
				displayMedications.sort();									// sort the array alphabetically	
				var tableSize = (displayMedications.length + 1);			// add 1 to the array length, so the table can have headers
				$("#resultsTable").empty();									// start with empty table
				
				for (var y = 0; y < tableSize; y++) {						// step down line by line...
					var row = ("<tr>");										// build a table row (note: don't *need* the brackets, but helps readablity)									
					for (var x = 0; x < tableSize; x++) {					// then per column					
						if (x == 0 && y == 0) {								// top left cell is special...
						
							if (tableSize == 1) {							// blank table, add a hint
								row += ("<td style='text-align:right'>");
								row +=   ("<span class='text-success'>");
								row +=     ("<i class='fas fa-arrow-up'></i>");
								row +=     (" Start by adding a medication here...");
								row +=   ("</span>");
								row += ("</td>");
							}
							else {
								row += ("<td></td>");						// otherwise blank cell
							}
						}
						else if (x == y) {									// diagonals...
							row += ("<td class='table-active'></td>");		// ... are grey
						}
						else {
							var rowTitle = displayMedications[y - 1];		// get the row header
							var columnTitle = displayMedications[x - 1];	// and the column header
							
							if (x == 0) {		// create row headers
								row += ("<th class='elementRow' scope='row' style='text-align:right'>");
								row +=   ("<a class='btn btn-outline-secondary deleteThisEntry' role='button' target='_new' href='" + medicationDetails[rowTitle]['url'] + "'>");
								row +=     (rowTitle);
								row +=   ("</a>");
								row +=   ("&nbsp;");
								row +=   ("<button class='btn btn-outline-danger deleteButton'>");
								row +=     ("<i class='far fa-trash-alt'></i>");
								row +=   ("</button>");
								row += ("</th>");
							}
							else if (y == 0) {	// create column headers
								row += ("<th scope='column' class='rotate col-xs-2'>");
								row +=   ("<div class='rotated'>");
								row +=     ("<a class='btn btn-outline-secondary' role='button' target='_new' href='" + medicationDetails[columnTitle]['url'] + "'>");
								row +=       (columnTitle);
								row +=     ("</a>");
								row +=   ("</div>");
								row += ("</th>");
							}
							else { 				// build the interaction cells
								if (medicationDetails[rowTitle]['interactions'][columnTitle]) {						// check if an interaction actually exists, if so:
									
									var url = medicationDetails[rowTitle]['interactions'][columnTitle]['url'];				// get the details, link
									var severity = medicationDetails[rowTitle]['interactions'][columnTitle]['severity'];	// ... severity ...
									var details = medicationDetails[rowTitle]['interactions'][columnTitle]['details'];		// and info about the interaction
									var colour = (severity == "Severe") ? "danger" : "warning";								// conditionally format the cell colour...
									var icon = (severity == "Severe") ? "fas fa-exclamation-triangle" : "fas fa-balance-scale";	// ... and icon from font awesome
									
												// cells with colourized button, link to the interaction details, and tooltip
									row += ("<td>");
									row +=   ("<a class='btn btn-outline-" + colour + "' role='button' target='_new' href='" + url + "' data-toggle='tooltip' title='" + details + "'>");
									row +=     ("<i class='" + icon + "'></i>");
									row +=   ("</a>");
									row += ("</td>");
								}
								else {			// no interaction found, colour a blank cell green with a thumbs up!
									row += ("<td>");
									row +=   ("<button type='button' class='btn btn-outline-success disabled' data-toggle='tooltip' title='No interactions listed.'>");
									row +=     ("<i class='fas fa-thumbs-up'></i>");
									row +=   ("</button>");
									row += ("</td>");
								}
							}
						}
					};			// end of iteration 'x'
					row += ("</tr>");						// finish the row tag
					$("#resultsTable").append(row);			// finished building the row, add this to the table's DOM
  				};				// end of iteration 'y'
  				
				$(".deleteButton").click( function(event){	// now we can assign actions to the elements
					event.preventDefault();									// stop the form from properly firing
					var entry = $(this).prev(".deleteThisEntry").text();	// we added the deleteThisEntry class to find the entry easily
   					deleteMedication(entry);									// pass the entry to the deleteRow code
				});			
			};

			// bind jQuery to the many ways to change the selection
			$("#searchBox").keyup( function() { formatButton() });
			$("#searchBox").blur(  function() { formatButton() });
			$("#searchBox").focus( function() { formatButton() });
			$("#searchBox").click( function() { formatButton() });

			function formatButton() {	// conditional formatting of the submitButton			
  				var searchTerm = $("#searchBox").val().toLowerCase();
  				if (searchTerm) {		// we have a non-empty box...
  					if (!displayMedications.includes(searchTerm)) {		// ... we don't already have it in the list...
  						if (availableMedications.includes(searchTerm)) {		// ... and it exists in the BNF! Success!
							$("#submitButton").prop('disabled', false);
							$("#submitButton").removeClass('disabled btn-outline-danger btn-outline-secondary btn-outline-success');
							$("#submitButton").addClass('btn-success');
  						}
  						else {			// otherwise, it doesn't exist in the BNF
							$("#submitButton").prop('disabled', true);
							$("#submitButton").removeClass('btn-success btn-outline-success btn-outline-secondary');
							$("#submitButton").addClass('btn-outline-danger disabled');
  						}
  					}
  					else {				// or we already have it
						$("#submitButton").prop('disabled', true);
						$("#submitButton").removeClass('btn-outline-danger btn-outline-secondary btn-success');
						$("#submitButton").addClass('btn-outline-success disabled');
  					}
  				}
  				else {					// or we have an empty box
		  			$("#submitButton").prop('disabled', true);
					$("#submitButton").removeClass('btn-outline-danger btn-outline-success btn-success');
					$("#submitButton").addClass('btn-outline-secondary disabled');
  				}
			}

			// bind the  tooltip to all the dynamically created items with 'data-toggle' properties
			$('body').tooltip({ selector: '[data-toggle="tooltip"]', delay: { 'show':300, 'hide':100 }, placement:'right' });

			// lastly, build the availableMedications list
			loadAvailableMedications();
			
			// and draw the first table...
			redrawTable();
			
			// :D
		});			
		</script>
	</body>
</html>